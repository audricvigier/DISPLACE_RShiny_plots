scale_linetype_manual(name="Métier", values=c(rep(1:4,each=5),3)[1:length(metChoice)])+
scale_shape_manual(name="Métier", values=c(rep(c(15:18),each=5),17)[1:length(metChoice)])+
geom_line(size=1,aes(colour=freq_metiers,linetype=freq_metiers))+
geom_point(size=2,aes(colour=freq_metiers,shape=freq_metiers))
plot2return
str(data4plot)
metierNames
data4plot$freq_metiers=factor(data4plot$freq_metiers,metierNames$metierId,metierNames$name)
plot2return = ggplot(data4plot,aes(x=time,y=value))+#,colour=freq_metiers,linetype=freq_metiers,shape=freq_metiers))+
labs(x=paste("Time step (",aggScale,")",sep=""),y=legendY,colour="Scenario",linetype="Scenario",shape="Scenario", title = legendTitle)+
expand_limits(y=0)+
theme_minimal()+
theme(axis.title.y = element_text(angle=0,vjust=0.5))
if(facet=="métier"){
plot2return = plot2return + facet_wrap(~freq_metiers,scales="free_y")+
geom_line(size=1,aes(colour=scename,linetype=scename))+
geom_point(size=2,aes(colour=scename,shape=scename))
}
if(facet=="scenario"){
plot2return = plot2return +
scale_colour_manual(name="Métier", values=rep(scales::hue_pal()(5),4)[1:length(metChoice)])+
scale_linetype_manual(name="Métier", values=c(rep(1:4,each=5),3)[1:length(metChoice)])+
scale_shape_manual(name="Métier", values=c(rep(c(15:18),each=5),17)[1:length(metChoice)])+
geom_line(size=1,aes(colour=freq_metiers,linetype=freq_metiers))+
geom_point(size=2,aes(colour=freq_metiers,shape=freq_metiers))
}
plot2return
getEconomicTimeSeries = function(data4plot,variable="revenue",cumulTime=T,metChoice=0, facet="métier",sce=NULL,aggScale="month"){
legendY = paste(variable,"\n","(EUR)",sep="")
legendTitle =  variable
if(cumulTime) legendTitle = paste("Cumul of ",variable,"\n",sep="")
if(facet=="scenario"){
legendTitle =  paste(variable,"\n",sce,sep="")
if(cumulTime) legendTitle = paste("Cumul of ",variable,"\n",sce,sep="")
}
#if(averageTrip)legendY = paste("Average\n",variable,"\nper trip\n(EUR)",sep="")
#if(cumulTime & averageTrip) legendY = paste("Cumulative\naverage\n",variable,"\nper trip\n(EUR)",sep="")
if(variable=="revenue") data4plot$value = data4plot$rev_from_av_prices
if(variable=="profit") data4plot$value = data4plot$gradva
if(variable=="fuelcost") data4plot$value = data4plot$fuelcost
if(variable=="nonFuelvariableCost") data4plot$value = data4plot$nonFuelvariableCost
if(variable=="GVA") data4plot$value = data4plot$GVA
if(variable=="GrossProfit") data4plot$value = data4plot$GrossProfit
if(variable=="LabourSurplus") data4plot$value = data4plot$LabourSurplus
if(variable=="NetProfit") data4plot$value = data4plot$NetProfit
if(variable=="NetProfitMargin") data4plot$value = data4plot$NetProfitMargin
if (!is.na(metChoice)) data4plot = subset(data4plot,freq_metiers%in%metChoice)
if (is.na(metChoice)) data4plot$freq_metiers="All"
if(variable %in%c("revenue","profit","fuelcost","nonFuelvariableCost")){
data4plot = data4plot %>%
filter(scename%in%sce) %>%
select(value,TStep,freq_metiers,scename) %>%
mutate(month = sapply(TStep, function(x) months$month[which(months$TStep==min(months$TStep[months$TStep>x]))] )) %>%
mutate(year=(floor((month-1)/12)))
if(aggScale=="year") data4plot = rename(data4plot,time=year)
if(aggScale=="month") data4plot = rename(data4plot,time=month)
data4plot = data4plot %>%
group_by(time,freq_metiers,scename) %>%
summarize(value=sum(value))%>%
ungroup() %>%
mutate(metierId=freq_metiers) %>%
merge(metierNames,by=c("metierId"),all.x=T)
#if (!is.na(metChoice)) data4plot= mutate(data4plot, freq_metiers = sapply(freq_metiers, function(x) metierNames$name[metierNames$metierId==x] ))
if(cumulTime){
data4plot = data4plot %>%
arrange(time,freq_metiers,scename) %>%
group_by(freq_metiers,scename) %>%
mutate(value=cumsum(value)) %>%
ungroup()
}
}
if(!variable %in%c("revenue","profit","fuelcost","nonFuelvariableCost")){
data4plot = data4plot %>%
filter(scename%in%sce) %>%
select(value,TStep,freq_metiers,VE_REF,scename) %>%
mutate(month = sapply(TStep, function(x) months$month[which(months$TStep==min(months$TStep[months$TStep>x]))] )) %>%
mutate(year=(floor((month-1)/12)))
if(aggScale=="year") data4plot = rename(data4plot,time=year)
if(aggScale=="month") data4plot = rename(data4plot,time=month)
data4plot = data4plot %>%
group_by(time,freq_metiers,VE_REF,scename) %>%
summarize(value=sum(value)) %>%
ungroup() %>%
complete(nesting(freq_metiers, VE_REF, scename),time=full_seq(time,1)) %>%
group_by(VE_REF,scename) %>% #If for the first time step, GVA is NA, then replace by 0; do not change it otherwise
mutate(value=replace(value,time==min(time) & is.na(value),0)) %>%
ungroup() %>%
arrange(scename,freq_metiers,VE_REF,time) %>%
fill(value,.direction="down") %>%
group_by(freq_metiers,time,scename) %>%
summarize(value=sum(value))%>%
ungroup()%>%
mutate(metierId=freq_metiers) %>%
merge(metierNames,by=c("metierId"),all.x=T)
#if (!is.na(metChoice)) data4plot= mutate(data4plot, freq_metiers = sapply(freq_metiers, function(x) metierNames$name[metierNames$metierId==x] ))
if(!cumulTime){
data4plot = data4plot %>%
arrange(scename,freq_metiers,time) %>%
group_by(scename,freq_metiers) %>%
mutate(value=c(min(value[time==min(time)]),diff(value))) %>%
ungroup()
}
}
data4plot$freq_metiers=factor(data4plot$freq_metiers,metierNames$metierId,metierNames$name)
plot2return = ggplot(data4plot,aes(x=time,y=value))+#,colour=freq_metiers,linetype=freq_metiers,shape=freq_metiers))+
labs(x=paste("Time step (",aggScale,")",sep=""),y=legendY,colour="Scenario",linetype="Scenario",shape="Scenario", title = legendTitle)+
expand_limits(y=0)+
theme_minimal()+
theme(axis.title.y = element_text(angle=0,vjust=0.5))
if(facet=="métier"){
plot2return = plot2return + facet_wrap(~freq_metiers,scales="free_y")+
geom_line(size=1,aes(colour=scename,linetype=scename))+
geom_point(size=2,aes(colour=scename,shape=scename))
}
if(facet=="scenario"){
plot2return = plot2return +
scale_colour_manual(name="Métier", values=rep(scales::hue_pal()(5),4)[1:length(metChoice)])+
scale_linetype_manual(name="Métier", values=c(rep(1:4,each=5),3)[1:length(metChoice)])+
scale_shape_manual(name="Métier", values=c(rep(c(15:18),each=5),17)[1:length(metChoice)])+
geom_line(size=1,aes(colour=freq_metiers,linetype=freq_metiers))+
geom_point(size=2,aes(colour=freq_metiers,shape=freq_metiers))
}
return(plot2return)
}
shinyApp(ui = ui, server = server, options = list("shiny.autoload.r" = FALSE))
data4plot = economicsTimeSeries
variable="revenue"
cumulTime=T
metChoice=c((0:16)[-5],NA)
facet="scenario"
sce=popdynscenarios
aggScale="year"
legendY = paste(variable,"\n","(EUR)",sep="")
legendTitle =  variable
if(cumulTime) legendTitle = paste("Cumul of ",variable,"\n",sep="")
if(facet=="scenario"){
legendTitle =  paste(variable,"\n",sce,sep="")
if(cumulTime) legendTitle = paste("Cumul of ",variable,"\n",sce,sep="")
}
#if(averageTrip)legendY = paste("Average\n",variable,"\nper trip\n(EUR)",sep="")
#if(cumulTime & averageTrip) legendY = paste("Cumulative\naverage\n",variable,"\nper trip\n(EUR)",sep="")
if(variable=="revenue") data4plot$value = data4plot$rev_from_av_prices
if(variable=="profit") data4plot$value = data4plot$gradva
if(variable=="fuelcost") data4plot$value = data4plot$fuelcost
if(variable=="nonFuelvariableCost") data4plot$value = data4plot$nonFuelvariableCost
if(variable=="GVA") data4plot$value = data4plot$GVA
if(variable=="GrossProfit") data4plot$value = data4plot$GrossProfit
if(variable=="LabourSurplus") data4plot$value = data4plot$LabourSurplus
if(variable=="NetProfit") data4plot$value = data4plot$NetProfit
if(variable=="NetProfitMargin") data4plot$value = data4plot$NetProfitMargin
if (!is.na(metChoice)) data4plot = subset(data4plot,freq_metiers%in%metChoice)
if (is.na(metChoice)) data4plot$freq_metiers="All"
if(variable %in%c("revenue","profit","fuelcost","nonFuelvariableCost")){
data4plot = data4plot %>%
filter(scename%in%sce) %>%
select(value,TStep,freq_metiers,scename) %>%
mutate(month = sapply(TStep, function(x) months$month[which(months$TStep==min(months$TStep[months$TStep>x]))] )) %>%
mutate(year=(floor((month-1)/12)))
if(aggScale=="year") data4plot = rename(data4plot,time=year)
if(aggScale=="month") data4plot = rename(data4plot,time=month)
data4plot = data4plot %>%
group_by(time,freq_metiers,scename) %>%
summarize(value=sum(value))%>%
ungroup() %>%
mutate(metierId=freq_metiers) %>%
merge(metierNames,by=c("metierId"),all.x=T)
#if (!is.na(metChoice)) data4plot= mutate(data4plot, freq_metiers = sapply(freq_metiers, function(x) metierNames$name[metierNames$metierId==x] ))
if(cumulTime){
data4plot = data4plot %>%
arrange(time,freq_metiers,scename) %>%
group_by(freq_metiers,scename) %>%
mutate(value=cumsum(value)) %>%
ungroup()
}
}
if(!variable %in%c("revenue","profit","fuelcost","nonFuelvariableCost")){
data4plot = data4plot %>%
filter(scename%in%sce) %>%
select(value,TStep,freq_metiers,VE_REF,scename) %>%
mutate(month = sapply(TStep, function(x) months$month[which(months$TStep==min(months$TStep[months$TStep>x]))] )) %>%
mutate(year=(floor((month-1)/12)))
if(aggScale=="year") data4plot = rename(data4plot,time=year)
if(aggScale=="month") data4plot = rename(data4plot,time=month)
data4plot = data4plot %>%
group_by(time,freq_metiers,VE_REF,scename) %>%
summarize(value=sum(value)) %>%
ungroup() %>%
complete(nesting(freq_metiers, VE_REF, scename),time=full_seq(time,1)) %>%
group_by(VE_REF,scename) %>% #If for the first time step, GVA is NA, then replace by 0; do not change it otherwise
mutate(value=replace(value,time==min(time) & is.na(value),0)) %>%
ungroup() %>%
arrange(scename,freq_metiers,VE_REF,time) %>%
fill(value,.direction="down") %>%
group_by(freq_metiers,time,scename) %>%
summarize(value=sum(value))%>%
ungroup()%>%
mutate(metierId=freq_metiers) %>%
merge(metierNames,by=c("metierId"),all.x=T)
#if (!is.na(metChoice)) data4plot= mutate(data4plot, freq_metiers = sapply(freq_metiers, function(x) metierNames$name[metierNames$metierId==x] ))
if(!cumulTime){
data4plot = data4plot %>%
arrange(scename,freq_metiers,time) %>%
group_by(scename,freq_metiers) %>%
mutate(value=c(min(value[time==min(time)]),diff(value))) %>%
ungroup()
}
}
unique(data4plot$freq_metiers)
unique(data4plot$metierId)
metChoice=NA
data4plot = economicsTimeSeries
variable="revenue"
cumulTime=T
metChoice=NA
facet="scenario"
sce=popdynscenarios
aggScale="year"
legendY = paste(variable,"\n","(EUR)",sep="")
legendTitle =  variable
if(cumulTime) legendTitle = paste("Cumul of ",variable,"\n",sep="")
if(facet=="scenario"){
legendTitle =  paste(variable,"\n",sce,sep="")
if(cumulTime) legendTitle = paste("Cumul of ",variable,"\n",sce,sep="")
}
#if(averageTrip)legendY = paste("Average\n",variable,"\nper trip\n(EUR)",sep="")
#if(cumulTime & averageTrip) legendY = paste("Cumulative\naverage\n",variable,"\nper trip\n(EUR)",sep="")
if(variable=="revenue") data4plot$value = data4plot$rev_from_av_prices
if(variable=="profit") data4plot$value = data4plot$gradva
if(variable=="fuelcost") data4plot$value = data4plot$fuelcost
if(variable=="nonFuelvariableCost") data4plot$value = data4plot$nonFuelvariableCost
if(variable=="GVA") data4plot$value = data4plot$GVA
if(variable=="GrossProfit") data4plot$value = data4plot$GrossProfit
if(variable=="LabourSurplus") data4plot$value = data4plot$LabourSurplus
if(variable=="NetProfit") data4plot$value = data4plot$NetProfit
if(variable=="NetProfitMargin") data4plot$value = data4plot$NetProfitMargin
if (!is.na(metChoice)) data4plot = subset(data4plot,freq_metiers%in%metChoice)
if (is.na(metChoice)) data4plot$freq_metiers="All"
if(variable %in%c("revenue","profit","fuelcost","nonFuelvariableCost")){
data4plot = data4plot %>%
filter(scename%in%sce) %>%
select(value,TStep,freq_metiers,scename) %>%
mutate(month = sapply(TStep, function(x) months$month[which(months$TStep==min(months$TStep[months$TStep>x]))] )) %>%
mutate(year=(floor((month-1)/12)))
if(aggScale=="year") data4plot = rename(data4plot,time=year)
if(aggScale=="month") data4plot = rename(data4plot,time=month)
data4plot = data4plot %>%
group_by(time,freq_metiers,scename) %>%
summarize(value=sum(value))%>%
ungroup() %>%
mutate(metierId=freq_metiers) %>%
merge(metierNames,by=c("metierId"),all.x=T)
#if (!is.na(metChoice)) data4plot= mutate(data4plot, freq_metiers = sapply(freq_metiers, function(x) metierNames$name[metierNames$metierId==x] ))
if(cumulTime){
data4plot = data4plot %>%
arrange(time,freq_metiers,scename) %>%
group_by(freq_metiers,scename) %>%
mutate(value=cumsum(value)) %>%
ungroup()
}
}
if(!variable %in%c("revenue","profit","fuelcost","nonFuelvariableCost")){
data4plot = data4plot %>%
filter(scename%in%sce) %>%
select(value,TStep,freq_metiers,VE_REF,scename) %>%
mutate(month = sapply(TStep, function(x) months$month[which(months$TStep==min(months$TStep[months$TStep>x]))] )) %>%
mutate(year=(floor((month-1)/12)))
if(aggScale=="year") data4plot = rename(data4plot,time=year)
if(aggScale=="month") data4plot = rename(data4plot,time=month)
data4plot = data4plot %>%
group_by(time,freq_metiers,VE_REF,scename) %>%
summarize(value=sum(value)) %>%
ungroup() %>%
complete(nesting(freq_metiers, VE_REF, scename),time=full_seq(time,1)) %>%
group_by(VE_REF,scename) %>% #If for the first time step, GVA is NA, then replace by 0; do not change it otherwise
mutate(value=replace(value,time==min(time) & is.na(value),0)) %>%
ungroup() %>%
arrange(scename,freq_metiers,VE_REF,time) %>%
fill(value,.direction="down") %>%
group_by(freq_metiers,time,scename) %>%
summarize(value=sum(value))%>%
ungroup()%>%
mutate(metierId=freq_metiers) %>%
merge(metierNames,by=c("metierId"),all.x=T)
#if (!is.na(metChoice)) data4plot= mutate(data4plot, freq_metiers = sapply(freq_metiers, function(x) metierNames$name[metierNames$metierId==x] ))
if(!cumulTime){
data4plot = data4plot %>%
arrange(scename,freq_metiers,time) %>%
group_by(scename,freq_metiers) %>%
mutate(value=c(min(value[time==min(time)]),diff(value))) %>%
ungroup()
}
}
unique(data4plot$freq_metiers)
unique(data4plot$freq_metiers)!="All"
#Aggregate at month or year level, otherwise rendering the plot is too resource demanding.
getEconomicTimeSeries = function(data4plot,variable="revenue",cumulTime=T,metChoice=0, facet="métier",sce=NULL,aggScale="month"){
legendY = paste(variable,"\n","(EUR)",sep="")
legendTitle =  variable
if(cumulTime) legendTitle = paste("Cumul of ",variable,"\n",sep="")
if(facet=="scenario"){
legendTitle =  paste(variable,"\n",sce,sep="")
if(cumulTime) legendTitle = paste("Cumul of ",variable,"\n",sce,sep="")
}
#if(averageTrip)legendY = paste("Average\n",variable,"\nper trip\n(EUR)",sep="")
#if(cumulTime & averageTrip) legendY = paste("Cumulative\naverage\n",variable,"\nper trip\n(EUR)",sep="")
if(variable=="revenue") data4plot$value = data4plot$rev_from_av_prices
if(variable=="profit") data4plot$value = data4plot$gradva
if(variable=="fuelcost") data4plot$value = data4plot$fuelcost
if(variable=="nonFuelvariableCost") data4plot$value = data4plot$nonFuelvariableCost
if(variable=="GVA") data4plot$value = data4plot$GVA
if(variable=="GrossProfit") data4plot$value = data4plot$GrossProfit
if(variable=="LabourSurplus") data4plot$value = data4plot$LabourSurplus
if(variable=="NetProfit") data4plot$value = data4plot$NetProfit
if(variable=="NetProfitMargin") data4plot$value = data4plot$NetProfitMargin
if (!is.na(metChoice)) data4plot = subset(data4plot,freq_metiers%in%metChoice)
if (is.na(metChoice)) data4plot$freq_metiers="All"
if(variable %in%c("revenue","profit","fuelcost","nonFuelvariableCost")){
data4plot = data4plot %>%
filter(scename%in%sce) %>%
select(value,TStep,freq_metiers,scename) %>%
mutate(month = sapply(TStep, function(x) months$month[which(months$TStep==min(months$TStep[months$TStep>x]))] )) %>%
mutate(year=(floor((month-1)/12)))
if(aggScale=="year") data4plot = rename(data4plot,time=year)
if(aggScale=="month") data4plot = rename(data4plot,time=month)
data4plot = data4plot %>%
group_by(time,freq_metiers,scename) %>%
summarize(value=sum(value))%>%
ungroup() %>%
mutate(metierId=freq_metiers) %>%
merge(metierNames,by=c("metierId"),all.x=T)
#if (!is.na(metChoice)) data4plot= mutate(data4plot, freq_metiers = sapply(freq_metiers, function(x) metierNames$name[metierNames$metierId==x] ))
if(cumulTime){
data4plot = data4plot %>%
arrange(time,freq_metiers,scename) %>%
group_by(freq_metiers,scename) %>%
mutate(value=cumsum(value)) %>%
ungroup()
}
}
if(!variable %in%c("revenue","profit","fuelcost","nonFuelvariableCost")){
data4plot = data4plot %>%
filter(scename%in%sce) %>%
select(value,TStep,freq_metiers,VE_REF,scename) %>%
mutate(month = sapply(TStep, function(x) months$month[which(months$TStep==min(months$TStep[months$TStep>x]))] )) %>%
mutate(year=(floor((month-1)/12)))
if(aggScale=="year") data4plot = rename(data4plot,time=year)
if(aggScale=="month") data4plot = rename(data4plot,time=month)
data4plot = data4plot %>%
group_by(time,freq_metiers,VE_REF,scename) %>%
summarize(value=sum(value)) %>%
ungroup() %>%
complete(nesting(freq_metiers, VE_REF, scename),time=full_seq(time,1)) %>%
group_by(VE_REF,scename) %>% #If for the first time step, GVA is NA, then replace by 0; do not change it otherwise
mutate(value=replace(value,time==min(time) & is.na(value),0)) %>%
ungroup() %>%
arrange(scename,freq_metiers,VE_REF,time) %>%
fill(value,.direction="down") %>%
group_by(freq_metiers,time,scename) %>%
summarize(value=sum(value))%>%
ungroup()%>%
mutate(metierId=freq_metiers) %>%
merge(metierNames,by=c("metierId"),all.x=T)
#if (!is.na(metChoice)) data4plot= mutate(data4plot, freq_metiers = sapply(freq_metiers, function(x) metierNames$name[metierNames$metierId==x] ))
if(!cumulTime){
data4plot = data4plot %>%
arrange(scename,freq_metiers,time) %>%
group_by(scename,freq_metiers) %>%
mutate(value=c(min(value[time==min(time)]),diff(value))) %>%
ungroup()
}
}
if(unique(data4plot$freq_metiers)!="All") data4plot$freq_metiers=factor(data4plot$freq_metiers,metierNames$metierId,metierNames$name)
plot2return = ggplot(data4plot,aes(x=time,y=value))+#,colour=freq_metiers,linetype=freq_metiers,shape=freq_metiers))+
labs(x=paste("Time step (",aggScale,")",sep=""),y=legendY,colour="Scenario",linetype="Scenario",shape="Scenario", title = legendTitle)+
expand_limits(y=0)+
theme_minimal()+
theme(axis.title.y = element_text(angle=0,vjust=0.5))
if(facet=="métier"){
plot2return = plot2return + facet_wrap(~freq_metiers,scales="free_y")+
geom_line(size=1,aes(colour=scename,linetype=scename))+
geom_point(size=2,aes(colour=scename,shape=scename))
}
if(facet=="scenario"){
plot2return = plot2return +
scale_colour_manual(name="Métier", values=rep(scales::hue_pal()(5),4)[1:length(metChoice)])+
scale_linetype_manual(name="Métier", values=c(rep(1:4,each=5),3)[1:length(metChoice)])+
scale_shape_manual(name="Métier", values=c(rep(c(15:18),each=5),17)[1:length(metChoice)])+
geom_line(size=1,aes(colour=freq_metiers,linetype=freq_metiers))+
geom_point(size=2,aes(colour=freq_metiers,shape=freq_metiers))
}
return(plot2return)
}
data4plot = economicsTimeSeries
variable="revenue"
cumulTime=T
metChoice=NA
facet="scenario"
sce=popdynscenarios
aggScale="year"
a=Sys.time()
getEconomicTimeSeries(data4plot,variable,cumulTime,metChoice,facet,sce,aggScale)
b=Sys.time()
b-a
data4plot = economicsTimeSeries
variable="revenue"
cumulTime=T
metChoice=NA
facet="scenario"
sce=popdynscenarios[2]
aggScale="year"
a=Sys.time()
getEconomicTimeSeries(data4plot,variable,cumulTime,metChoice,facet,sce,aggScale)
b=Sys.time()
b-a
getEconomicTimeSeries = function(data4plot,variable="revenue",cumulTime=T,metChoice=0, facet="métier",sce=NULL,aggScale="month"){
legendY = paste(variable,"\n","(EUR)",sep="")
legendTitle =  variable
if(cumulTime) legendTitle = paste("Cumul of ",variable,"\n",sep="")
if(facet=="scenario"){
legendTitle =  paste(variable,"\n",sce,sep="")
if(cumulTime) legendTitle = paste("Cumul of ",variable,"\n",sce,sep="")
}
#if(averageTrip)legendY = paste("Average\n",variable,"\nper trip\n(EUR)",sep="")
#if(cumulTime & averageTrip) legendY = paste("Cumulative\naverage\n",variable,"\nper trip\n(EUR)",sep="")
if(variable=="revenue") data4plot$value = data4plot$rev_from_av_prices
if(variable=="profit") data4plot$value = data4plot$gradva
if(variable=="fuelcost") data4plot$value = data4plot$fuelcost
if(variable=="nonFuelvariableCost") data4plot$value = data4plot$nonFuelvariableCost
if(variable=="GVA") data4plot$value = data4plot$GVA
if(variable=="GrossProfit") data4plot$value = data4plot$GrossProfit
if(variable=="LabourSurplus") data4plot$value = data4plot$LabourSurplus
if(variable=="NetProfit") data4plot$value = data4plot$NetProfit
if(variable=="NetProfitMargin") data4plot$value = data4plot$NetProfitMargin
if (!is.na(metChoice)) data4plot = subset(data4plot,freq_metiers%in%metChoice)
if (is.na(metChoice)) data4plot$freq_metiers="All"
if(variable %in%c("revenue","profit","fuelcost","nonFuelvariableCost")){
data4plot = data4plot %>%
filter(scename%in%sce) %>%
select(value,TStep,freq_metiers,scename) %>%
mutate(month = sapply(TStep, function(x) months$month[which(months$TStep==min(months$TStep[months$TStep>x]))] )) %>%
mutate(year=(floor((month-1)/12)))
if(aggScale=="year") data4plot = rename(data4plot,time=year)
if(aggScale=="month") data4plot = rename(data4plot,time=month)
data4plot = data4plot %>%
group_by(time,freq_metiers,scename) %>%
summarize(value=sum(value))%>%
ungroup() %>%
mutate(metierId=freq_metiers) %>%
merge(metierNames,by=c("metierId"),all.x=T)
#if (!is.na(metChoice)) data4plot= mutate(data4plot, freq_metiers = sapply(freq_metiers, function(x) metierNames$name[metierNames$metierId==x] ))
if(cumulTime){
data4plot = data4plot %>%
arrange(time,freq_metiers,scename) %>%
group_by(freq_metiers,scename) %>%
mutate(value=cumsum(value)) %>%
ungroup()
}
}
if(!variable %in%c("revenue","profit","fuelcost","nonFuelvariableCost")){
data4plot = data4plot %>%
filter(scename%in%sce) %>%
select(value,TStep,freq_metiers,VE_REF,scename) %>%
mutate(month = sapply(TStep, function(x) months$month[which(months$TStep==min(months$TStep[months$TStep>x]))] )) %>%
mutate(year=(floor((month-1)/12)))
if(aggScale=="year") data4plot = rename(data4plot,time=year)
if(aggScale=="month") data4plot = rename(data4plot,time=month)
data4plot = data4plot %>%
group_by(time,freq_metiers,VE_REF,scename) %>%
summarize(value=sum(value)) %>%
ungroup() %>%
complete(nesting(freq_metiers, VE_REF, scename),time=full_seq(time,1)) %>%
group_by(VE_REF,scename) %>% #If for the first time step, GVA is NA, then replace by 0; do not change it otherwise
mutate(value=replace(value,time==min(time) & is.na(value),0)) %>%
ungroup() %>%
arrange(scename,freq_metiers,VE_REF,time) %>%
fill(value,.direction="down") %>%
group_by(freq_metiers,time,scename) %>%
summarize(value=sum(value))%>%
ungroup()%>%
mutate(metierId=freq_metiers) %>%
merge(metierNames,by=c("metierId"),all.x=T)
#if (!is.na(metChoice)) data4plot= mutate(data4plot, freq_metiers = sapply(freq_metiers, function(x) metierNames$name[metierNames$metierId==x] ))
if(!cumulTime){
data4plot = data4plot %>%
arrange(scename,freq_metiers,time) %>%
group_by(scename,freq_metiers) %>%
mutate(value=c(min(value[time==min(time)]),diff(value))) %>%
ungroup()
}
}
if(unique(data4plot$freq_metiers)!="All") data4plot$freq_metiers=factor(data4plot$freq_metiers,metierNames$metierId,metierNames$name)
plot2return = ggplot(data4plot,aes(x=time,y=value))+#,colour=freq_metiers,linetype=freq_metiers,shape=freq_metiers))+
labs(x=paste("Time step (",aggScale,")",sep=""),y=legendY,colour="Scenario",linetype="Scenario",shape="Scenario", title = legendTitle)+
expand_limits(y=0)+
theme_minimal()+
theme(axis.title.y = element_text(angle=0,vjust=0.5))
if(facet=="métier"){
plot2return = plot2return + facet_wrap(~freq_metiers,scales="free_y")+
geom_line(size=1,aes(colour=scename,linetype=scename))+
geom_point(size=2,aes(colour=scename,shape=scename))
}
if(facet=="scenario"){
plot2return = plot2return +
scale_colour_manual(name="Métier", values=rep(scales::hue_pal()(5),4)[1:length(metChoice)])+
scale_linetype_manual(name="Métier", values=c(rep(1:4,each=5),3)[1:length(metChoice)])+
scale_shape_manual(name="Métier", values=c(rep(c(15:18),each=5),17)[1:length(metChoice)])+
geom_line(size=1,aes(colour=freq_metiers,linetype=freq_metiers))+
geom_point(size=2,aes(colour=freq_metiers,shape=freq_metiers))
}
return(plot2return)
}
shinyApp(ui = ui, server = server, options = list("shiny.autoload.r" = FALSE))
